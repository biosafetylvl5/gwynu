<!DOCTYPE html>
<html>
	<head>
		<style>
			canvas {
				display: block;
			}
			#workspace{
				width:100%;
			}
			.worker {
				display:inline-block;
				margin: 0 auto;
			}
			.token{
				display: inline-block;
				margin-right: 10px;
			}
			.tag-token{
				height: 15px;
				width: 25px;
				display: inline-block;
				margin-right: 10px;
				position: relative;
				top: 2px;
			}
			#tags{
				margin-top:40px;
				margin-bottom:40px;

			}
			select {
				width: 200px;
				max-width: 100%;
				/* So it doesn't overflow from it's parent */
			}

			option {
				/* wrap text in compatible browsers */
				-moz-white-space: pre-wrap;
				-o-white-space: pre-wrap;
				white-space: pre-wrap;
				/* hide text that can't wrap with an ellipsis */
				overflow: hidden;
				text-overflow: ellipsis;
				/* add border after every option */
				border-bottom: 1px solid #DDD;
			}
		</style>
		<script type="text/javascript" src="./res/papaparse.min.js"></script>
		<script type="text/javascript" src="./res/FileSaver.min.js"></script>
		<script>
			let csvData = undefined
			let images = undefined
			let groupSize = undefined
			let currentImage = 0
			let fileName = undefined
            let imageList = []
            let tagList = []
			let palette = ["red", "blue", "black", "white"]
			function getColor(tag) {
				return palette[tagList.indexOf(tag)%palette.length]
			}
            function loadCsvData(results) {
				csvData = results
				let imageSet = new Set()
				let tagSet = new Set()
				for(let i in results["data"]){
					imageSet.add(results["data"][i]["Input.image_url"])
					let boundingBoxes = JSON.parse(results["data"][i]["Answer.annotatedResult.boundingBoxes"])
                    for (let j in boundingBoxes){
                    	tagSet.add(boundingBoxes[j]["label"])
					}
					imageSet.add(results["data"][i]["Input.image_url"])
				}
				imageList = Array.from(imageSet)
				tagList = Array.from(tagSet)
                imageList.sort()
				tagList.sort()
			}
			function loadCsv(){
				const csvFile = document.getElementById("csv-upload")
				fileName = csvFile.files[0].name
				Papa.parse(csvFile.files[0], 
				{complete: loadCsvData, header: true})
			}
			function loadImages(){
				const selectedImages = document.getElementById("images-upload").files
				images = selectedImages
			}
			function validateInputs(){
				groupSize = document.getElementById("groupSize").value;
				if ((groupSize==undefined)||(groupSize=="")){
					alert("Please specify a group size.")
					return false
				}
				if (csvData==undefined){
					alert("Please choose a csv file.")
					return false
				}
				if (images==undefined){
					alert("Please select some images.")
					return false
				}
				return true
			}
			function createCanvases(num){
				let workspace = document.getElementById("workspace")
                workspace.style.display="block"
				document.getElementById("workspace").childNodes[2].remove()
				document.getElementById("workspace").childNodes[0].remove()
				for(i=1;i<num;i++){
					workspace.appendChild(workspace.firstChild.cloneNode(true))
				}
			}
			function populateTagLegend(){
				let tags = document.getElementById("tags")
				tags.childNodes[2].remove()
				tags.childNodes[0].remove()
				for (let i=1;i<tagList.length;i++){
					tags.appendChild(tags.firstChild.cloneNode(true))
				}
				for (let i=0;i<tagList.length;i++) {
					tags.children[i].children[1].innerText = tagList[i]
					tags.children[i].children[0].style.backgroundColor = getColor(tagList[i])
                }
				tags.style.display="block"
			}
			function init(){
				if (!validateInputs()) return
				createCanvases(groupSize)
				populateTagLegend()
				document.getElementById("controls").style.display="block"
                load("")
			}
			function getImageFromImageName(imageName) {
				for(let i=0;i<images.length;i++){
					if (images[i]["name"]==imageName){
						return images[i]
					}
				}
				throw "Image not in uploaded images!!"
			}
			function getDataForImage(imageName) {
				returnData = []
                for(let i in csvData["data"]){
                    let data = csvData["data"][i]
					if(data["Input.image_url"]===imageName){
                    	returnData.push(data)
					}
				}
                return returnData
			}
			function load(){
				let image = imageList[currentImage]
				let data = getDataForImage(image)
				for(let i=0;i<groupSize;i++){
                    let canvas = document.getElementById("workspace").childNodes[i].childNodes[1]
					onload = function(ctx, xScalar, yScalar){
						if(i>=data.length){
                    		return
						}
						let dataBoxes = JSON.parse(data[i]["Answer.annotatedResult.boundingBoxes"])
						for(let x=0;x<dataBoxes.length;x++){
                    		drawBoundingBox(ctx,
									dataBoxes[x]["left"]*xScalar,
									dataBoxes[x]["top"]*yScalar,
									dataBoxes[x]["width"]*xScalar,
									dataBoxes[x]["height"]*yScalar,
									getColor(dataBoxes[x]["label"]))
						}
					}
					drawImage(canvas, window.URL.createObjectURL(getImageFromImageName(image)), "", onload)
				}
				document.getElementById("loader").style.display="none"
			}

			function drawBoundingBox(ctx, x, y, height, width, color) {
				ctx.beginPath();
				ctx.lineWidth = "3"
				ctx.strokeStyle = color
				ctx.rect(x,y,height,width)
				ctx.stroke()
			}

			function drawImage(canvas, src, data, onload){
				// draws an image with src in workspace area i with bounding boxes defined by data
				const imageTargetWidth = window.innerWidth / (parseInt(groupSize, 10)+1)
				let img = new Image();
				img.onload = function(){
					canvas.width = imageTargetWidth
					canvas.height = imageTargetWidth * img.height/img.width
					canvas.getContext("2d").drawImage(img,0,0, imageTargetWidth, imageTargetWidth * img.height/img.width)
					let ctx = canvas.getContext("2d")
                    onload(ctx, canvas.width/img.width, canvas.height/img.height)
				}
				img.src = src
			}
			function saveImage(worker) {
				let canvas = worker.children[0]
				canvas.toBlob((blob) => {saveAs(blob, "test.png")})

			}
			function download(){
				data = Papa.unparse(csvData)
				file = new Blob([data], {type: "text/plain;charset=utf-8"})
				saveAs(file, fileName+".annotated.csv")
			}
			function incImage(i) {
				currentImage = currentImage+i//Math.max(0, Math.min(csvData.length, currentImage+parseInt(i)))
				console.log(currentImage)
                load("")
			}
			function handleOther(that) {
				if (that.value==""){
					that.parentElement.getElementsByTagName("input")[0].checked=true
                    return
				}
			    if (that.value=="OTHER") {
					let newReject = prompt("Please input the other reason:")
                    let selects = document.getElementsByTagName("select")
					for (let i=0;i<selects.length;i++){
						let option = document.createElement("option");
						option.appendChild(document.createTextNode(newReject))
						option.value = newReject
						selects[i].append(option)
					}
                    that.value = newReject
				}
				that.parentElement.getElementsByTagName("input")[0].checked=false
			}
			function updateReject(that) {
				if (that.checked===true) {
					that.parentElement.getElementsByTagName("select")[0].value = ""
				}
			}
		</script>
	</head>
	<body>
		<div id="workspace" style="display: none">
			<div class="worker">
				<canvas id="canvas" width="200" height="100"></canvas>
                <input type="checkbox" id="approve" value="Approve" checked="true" onchange="updateReject(this)"/>Approve<br/>
				<select name="reject" id="reject" onchange="handleOther(this)">
					<option value=""></option>
					<option value="Instructions blatantly not followed, worker might have misread them">Instructions blatantly not followed, worker might have misread them</option>
                    <option value="OTHER">Other...</option>
				</select><br/><br/>
				<input type="checkbox" id="use" />Don't use even if not rejected<br/><br/>
				<input type="button" value="Save Annotated Image" onclick="saveImage(this.parentNode)"/>
			</div>
		</div>
        <br/>
		<div id="loader">
			<div>CSV: <input type="file" id="csv-upload" accept=".csv" onchange="loadCsv()"/></div>
			<div>Group Size: <input type="number" id="groupSize" value="3"/></div>
			<div>Images: <input type="file" id="images-upload" accept=".webp, .png, .jpg, .jpeg, .gif" onchange="loadImages()" multiple/></div>
			<div><input type="button" id="load" value="Load" onclick="init()"/></div>
		</div>
		<div id="tags" style="display: none">
			<div class="token">
				<div id="tag-token" class="tag-token" style="background-color:blue"></div>
				<span id="tag-text">Text</span>
			</div>


		</div>
    	<div id="controls" style="display: none;">
			<input type="button" value="Next" onclick="incImage(1)"/>
			<input type="button" value="Previous" onclick="incImage(-1)"/>
			<br/>
			<input type="button" value="Save Annotated Data as CSV" onclick="download()"/>
		</div>
	</body>
</html>
